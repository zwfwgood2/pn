## 1. 系统概述

省级节点服务是连接市级节点与全国节点的中间层服务，负责数据的中转、验证、路由和日志记录。该服务采用模块化、可扩展的设计，支持不同类型接口的灵活处理。

## 2. 系统架构

系统采用分层架构设计，主要包括以下几层：

1. **API层**：接收市级节点的请求，统一入口
2. **控制层**：处理请求路由和响应返回
3. **处理层**：实现核心业务逻辑，采用节点链模式
4. **数据访问层**：与数据库交互，提供数据持久化功能
5. **公共层**：提供通用组件和工具类
6. **缓存层**：使用Redis缓存常用数据，提高系统性能

系统架构图如下：

```
┌───────────────┐     ┌───────────────┐     ┌───────────────┐
│  市级节点A    │     │  市级节点B    │     │  市级节点C    │
└───────────────┘     └───────────────┘     └───────────────┘
        │                     │                     │
        └─────────────┬───────┴─────────────┬───────┘
                      │                     │
              ┌───────▼─────────────────────▼───────┐
              │             省级节点服务             │
              ├─────────────────────────────────────┤
              │  API层  │  控制层  │  处理层  │ 数据层│
              │─────────┼─────────┼─────────┼───────│
              │ Main    │ Main    │Interface│ JPA   │
              │Controller│Controller│Processor│Repositories│
              │ Auth    │         │  Node   │ MyBatis│
              │Controller│         │  Chain  │ Mapper │
              ├─────────────────────────────────────┤
              │               缓存层                │
              │            Redis缓存服务            │
              └─────────────────────────────────────┘
                      │                     │
              ┌───────▼─────────┐   ┌───────▼───────┐
              │  本地数据库     │   │  全国节点服务  │
              └─────────────────┘   └───────────────┘
```

## 3. 核心功能模块

### 3.1 接口处理框架

采用责任链模式设计的节点处理框架，支持灵活配置和组合不同的处理节点，以适应不同类型接口的处理需求。

主要组件：
- **Node**：基础节点接口，定义了处理逻辑
- **ProcessEngine**：流程引擎，负责执行节点链

### 3.2 安全认证模块

提供完整的认证授权机制，确保只有授权的市级节点可以访问系统。

主要功能：
- 令牌验证（TokenValidateNode）
- 签名验证（SignatureVerifyNode）
- 数据签名（SignatureNode）
- 接入机构认证

### 3.3 参数验证模块

提供灵活的参数验证机制，确保请求参数的合法性和完整性。

主要功能：
- 参数必填性检查
- 数据类型验证
- 长度校验
- 正则表达式验证

### 3.4 日志记录模块

记录详细的请求和响应日志，用于审计、排查问题和性能监控。

主要功能：
- 请求参数记录
- 处理结果记录
- 异常信息记录
- 处理时间统计
- 流程执行记录

### 3.5 重试与异常处理模块

提供完善的重试机制和异常处理策略，确保系统的高可用性和稳定性。

主要功能：
- 指数退避重试
- 异常分类处理
- 错误码映射

### 3.6 缓存管理模块

使用Redis缓存常用数据，提高系统性能，减轻数据库压力。

主要功能：
- 系统启动时缓存预热（CacheInitializer）
- 接入机构信息多维度缓存
- 流程节点配置缓存
- 缓存自动刷新机制

## 4. 核心实体

### 4.1 AccessOrganization

接入机构实体类，用于存储市级节点等机构信息。

主要属性：
- id：唯一标识
- orgName：机构名称
- orgCode：机构代码
- username：用户名（登录账号）
- password：密码
- appKey：应用密钥
- publicKey：公钥
- privateKey：私钥
- status：状态（0:禁用, 1:启用）
- createTime：创建时间
- updateTime：更新时间
- lastLoginTime：最后登录时间
- isAdmin：是否管理员
- structureType：结构类型（0:省级节点, 1:市级节点, 2:其他）
- contactPerson：联系人
- contactPhone：联系电话
- description：描述

### 4.2 InterfaceDefinition

接口定义实体类，存储系统中所有接口的定义信息。

主要属性：
- id：唯一标识
- interfaceCode：接口代码
- interfaceName：接口名称
- interfaceType：接口类型（0:查询接口, 1:写入接口）
- requestMethod：请求方法（GET, POST, PUT, DELETE等）
- requestPath：请求路径
- processCode：关联的流程定义代码
- processConfig：接口处理流程配置
- paramValidateConfig：参数校验配置
- status：状态（0:禁用, 1:启用）
- createTime：创建时间
- updateTime：更新时间
- description：描述

### 4.3 ProcessDefinition

流程定义实体类，存储接口处理流程的定义信息。

主要属性：
- id：唯一标识
- processCode：流程代码
- processName：流程名称
- interfaceCode：接口代码
- description：描述
- status：状态（0:禁用, 1:启用）
- createTime：创建时间
- updateTime：更新时间

### 4.4 ProcessNodeConfig

流程节点配置实体类，存储流程中每个节点的配置信息。

主要属性：
- id：唯一标识
- processCode：流程代码
- nodeId：节点ID
- nodeName：节点名称
- nodeOrder：节点顺序
- retryConfig：重试配置
- asyncExecution：是否异步执行
- nodeConfig：节点配置参数
- status：状态（0:禁用, 1:启用）
- createTime：创建时间
- updateTime：更新时间

### 4.5 RequestLog

请求日志实体类，记录每次接口调用的详细信息。

主要属性：
- id：唯一标识
- requestId：请求ID
- interfaceCode：接口代码
- appKey：应用密钥
- requestTime：请求时间
- responseTime：响应时间
- requestParams：请求参数
- responseResult：响应结果
- status：状态（0:失败, 1:成功）
- errorMessage：错误信息
- requestIp：请求IP
- processingTime：处理耗时（毫秒）

## 5. 数据库设计

### 5.1 数据库概述

省级节点服务采用关系型数据库存储系统数据，包括接入机构信息、接口定义、流程配置和请求日志等。

### 5.2 数据库连接信息

- **数据库类型**：MySQL
- **字符集**：UTF-8mb4
- **排序规则**：utf8mb4_unicode_ci
- **连接池**：HikariCP

### 5.3 表结构设计

#### 5.3.1 sys_access_organization（接入机构表）

存储接入机构信息，合并了原User和Organization表的功能。

```sql
CREATE TABLE `sys_access_organization` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `org_name` varchar(100) NOT NULL COMMENT '机构名称',
  `org_code` varchar(50) NOT NULL COMMENT '机构代码',
  `username` varchar(50) NOT NULL COMMENT '用户名（登录账号）',
  `password` varchar(255) NOT NULL COMMENT '密码（加密存储）',
  `app_key` varchar(100) NOT NULL COMMENT '应用密钥',
  `public_key` text COMMENT '公钥',
  `private_key` text COMMENT '私钥（加密存储）',
  `status` tinyint(4) NOT NULL DEFAULT '1' COMMENT '状态：0-禁用，1-启用',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `last_login_time` datetime DEFAULT NULL COMMENT '最后登录时间',
  `is_admin` tinyint(4) NOT NULL DEFAULT '0' COMMENT '是否管理员：0-否，1-是',
  `structure_type` tinyint(4) NOT NULL DEFAULT '1' COMMENT '结构类型：0-省级节点，1-市级节点，2-其他',
  `contact_person` varchar(50) DEFAULT NULL COMMENT '联系人',
  `contact_phone` varchar(20) DEFAULT NULL COMMENT '联系电话',
  `description` varchar(255) DEFAULT NULL COMMENT '描述',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_org_code` (`org_code`),
  UNIQUE KEY `uk_username` (`username`),
  UNIQUE KEY `uk_app_key` (`app_key`),
  KEY `idx_status` (`status`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='接入机构表';
```

#### 5.3.2 sys_interface_definition（接口定义表）

存储系统中所有接口的定义信息。

```sql
CREATE TABLE `sys_interface_definition` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `interface_code` varchar(50) NOT NULL COMMENT '接口代码',
  `interface_name` varchar(100) NOT NULL COMMENT '接口名称',
  `interface_type` tinyint(4) NOT NULL DEFAULT '0' COMMENT '接口类型：0-查询接口，1-写入接口',
  `request_method` varchar(20) NOT NULL DEFAULT 'POST' COMMENT '请求方法：GET, POST, PUT, DELETE等',
  `request_path` varchar(200) NOT NULL COMMENT '请求路径',
  `process_code` varchar(50) NOT NULL COMMENT '关联的流程定义代码',
  `process_config` text COMMENT '接口处理流程配置（JSON格式）',
  `param_validate_config` text COMMENT '参数校验配置（JSON格式）',
  `status` tinyint(4) NOT NULL DEFAULT '1' COMMENT '状态：0-禁用，1-启用',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `description` varchar(255) DEFAULT NULL COMMENT '描述',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_interface_code` (`interface_code`),
  UNIQUE KEY `uk_request_path` (`request_path`),
  KEY `idx_interface_type` (`interface_type`),
  KEY `idx_status` (`status`),
  KEY `idx_process_code` (`process_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='接口定义表';
```

#### 5.3.3 sys_process_definition（流程定义表）

存储接口处理流程的定义信息。

```sql
CREATE TABLE `sys_process_definition` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `process_code` varchar(50) NOT NULL COMMENT '流程代码',
  `process_name` varchar(100) NOT NULL COMMENT '流程名称',
  `interface_code` varchar(50) DEFAULT NULL COMMENT '接口代码（关联sys_interface_definition表）',
  `description` varchar(255) DEFAULT NULL COMMENT '描述',
  `status` tinyint(4) NOT NULL DEFAULT '1' COMMENT '状态：0-禁用，1-启用',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_process_code` (`process_code`),
  KEY `idx_interface_code` (`interface_code`),
  KEY `idx_status` (`status`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='流程定义表';
```

#### 5.3.4 sys_process_node_config（流程节点配置表）

存储流程中每个节点的配置信息。

```sql
CREATE TABLE `sys_process_node_config` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `process_code` varchar(50) NOT NULL COMMENT '流程代码（关联sys_process_definition表）',
  `node_id` varchar(50) NOT NULL COMMENT '节点ID',
  `node_name` varchar(100) NOT NULL COMMENT '节点名称',
  `node_order` int(11) NOT NULL COMMENT '节点顺序',
  `retry_config` text COMMENT '重试配置（JSON格式）',
  `async_execution` tinyint(4) NOT NULL DEFAULT '0' COMMENT '是否异步执行：0-否，1-是',
  `node_config` text COMMENT '节点配置参数（JSON格式）',
  `status` tinyint(4) NOT NULL DEFAULT '1' COMMENT '状态：0-禁用，1-启用',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_process_code_node_id` (`process_code`,`node_id`),
  KEY `idx_process_code` (`process_code`),
  KEY `idx_status` (`status`),
  KEY `idx_node_order` (`node_order`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='流程节点配置表';
```

#### 5.3.5 sys_request_log（请求日志表）

记录每次接口调用的详细信息。

```sql
CREATE TABLE `sys_request_log` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `request_id` varchar(100) NOT NULL COMMENT '请求ID',
  `interface_code` varchar(50) NOT NULL COMMENT '接口代码',
  `app_key` varchar(100) NOT NULL COMMENT '应用密钥（关联sys_access_organization表）',
  `request_time` datetime NOT NULL COMMENT '请求时间',
  `response_time` datetime DEFAULT NULL COMMENT '响应时间',
  `request_params` text COMMENT '请求参数（JSON格式）',
  `response_result` text COMMENT '响应结果（JSON格式）',
  `status` tinyint(4) NOT NULL DEFAULT '0' COMMENT '状态：0-失败，1-成功',
  `error_message` text COMMENT '错误信息',
  `request_ip` varchar(50) DEFAULT NULL COMMENT '请求IP',
  `processing_time` bigint(20) DEFAULT NULL COMMENT '处理耗时（毫秒）',
  PRIMARY KEY (`id`),
  KEY `idx_request_id` (`request_id`),
  KEY `idx_interface_code` (`interface_code`),
  KEY `idx_app_key` (`app_key`),
  KEY `idx_request_time` (`request_time`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='请求日志表';
```

### 5.4 表关系图

```
┌─────────────────────────────┐       ┌─────────────────────────────┐
│  sys_access_organization    │       │  sys_interface_definition   │
│                             │       │                             │
│  - id                       │       │  - id                       │
│  - org_code                 │       │  - interface_code           │
│  - username                 │       │  - interface_name           │
│  - app_key                  │       │  - interface_type           │
│  - status                   │       │  - request_method           │
│  - create_time              │       │  - request_path             │
│  - update_time              │       │  - process_code             │
│  - last_login_time          │       │  - status                   │
│  - is_admin                 │       │  - create_time              │
│  - structure_type           │       │  - update_time              │
│  - contact_person           │       │  - description              │
│  - contact_phone            │       │                             │
│  - description              │       │                             │
└───────────┬─────────────────┘       └───────────┬─────────────────┘
            │                                     │
            │                                     │
            │                                     ▼
            │                             ┌─────────────────────────────┐
            │                             │    sys_process_definition   │
            │                             │                             │
            │                             │  - id                       │
            │                             │  - process_code             │
            │                             │  - process_name             │
            │                             │  - interface_code           │
            │                             │  - status                   │
            │                             │  - create_time              │
            │                             │  - update_time              │
            │                             │  - description              │
            │                             │                             │
            │                             └───────────┬─────────────────┘
            │                                         │
            │                                         │
            │                                         ▼
            │                                 ┌─────────────────────────┐
            │                                 │ sys_process_node_config │
            │                                 │                         │
            │                                 │  - id                   │
            │                                 │  - process_code         │
            │                                 │  - node_id              │
            │                                 │  - node_name            │
            │                                 │  - node_order           │
            │                                 │  - retry_config         │
            │                                 │  - async_execution      │
            │                                 │  - node_config          │
            │                                 │  - status               │
            │                                 │  - create_time          │
            │                                 │  - update_time          │
            │                                 │  - description          │
            │                                 │                         │
            │                                 └─────────────────────────┘
            │
            ▼
┌─────────────────────────────┐
│        sys_request_log      │
│                             │
│  - id                       │
│  - request_id               │
│  - interface_code           │
│  - app_key                  │
│  - request_time             │
│  - response_time            │
│  - request_params           │
│  - response_result          │
│  - status                   │
│  - error_message            │
│  - request_ip               │
│  - processing_time          │
│                             │
└─────────────────────────────┘
```

## 6. 核心代码示例

### 6.1 MainController代码示例

MainController是系统的主控制器，负责处理所有接口请求并调用流程引擎执行相应的处理流程。

```java
package com.example.provincialnode.controller;

import com.alibaba.fastjson.JSONObject;
import com.example.provincialnode.common.Result;
import com.example.provincialnode.common.ResultCode;
import com.example.provincialnode.entity.SysInterfaceDefinitionEntity;
import com.example.provincialnode.processor.ProcessEngine;
import com.example.provincialnode.processor.context.ProcessContext;
import com.example.provincialnode.service.SysInterfaceDefinitionService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import javax.servlet.http.HttpServletRequest;
import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

/**
 * 主控制器类
 * 处理所有接口请求，按照接口后缀找到流程执行
 */
@Slf4j
@RestController
@RequestMapping("/api")
public class MainController {

    @Autowired
    private SysInterfaceDefinitionService sysInterfaceDefinitionService;

    @Autowired
    private ProcessEngine processEngine;

    /**
     * 处理所有接口请求
     * 通配符路径，根据URL后缀识别接口
     */
    @RequestMapping(value = "{code}", method = {RequestMethod.GET, RequestMethod.POST, RequestMethod.PUT, RequestMethod.DELETE})
    public Result<JSONObject> handleRequest(MultipartFile file, @PathVariable String code , HttpServletRequest request, @RequestBody(required = false) Map<String, Object> requestBody) {
        // 1. 获取请求URL和请求方法
        String requestURI = request.getRequestURI();
        String requestMethod = request.getMethod();
        // 2. 从URL中提取接口路径
        // 去除上下文路径
        String contextPath = request.getContextPath();
        String interfacePath = requestURI.substring(contextPath.length());
        
        log.info("收到请求: URL={}, Method={}", interfacePath, requestMethod);
        
        try {
            // 3. 根据请求路径查询接口定义
            SysInterfaceDefinitionEntity interfaceDefinition = sysInterfaceDefinitionService.findByRequestPath(interfacePath);
            if(interfaceDefinition == null){
               Result.error(ResultCode.NOT_FOUND.getCode(), "接口定义不存在");
            }

            // 4. 检查接口是否启用
            if (interfaceDefinition.getStatus() != 1) {
                log.error("接口未启用: {}", interfacePath);
                return Result.error(ResultCode.SERVICE_UNAVAILABLE.getCode(), "接口未启用");
            }
            
            // 5. 获取接口代码
            String interfaceCode = interfaceDefinition.getInterfaceCode();
            
            // 6. 构建处理上下文
            ProcessContext context = buildProcessContext(request, requestBody, interfaceCode, interfaceDefinition);
            
            // 7.按照接口维度加载流程执行
            // 检查接口是否配置了特定流程
            String processCode = interfaceDefinition.getProcessCode();
            // 使用流程引擎执行流程
            Result<JSONObject> result = processEngine.executeProcess(processCode, context);
            log.info("接口请求处理完成: {}, 结果: {}", interfaceCode, result.getCode());
            return result;
        } catch (Exception e) {
            String errorMsg = "处理请求异常: " + e.getMessage();
            log.error(errorMsg, e);
            // 记录异常日志
            String requestId = UUID.randomUUID().toString();
            log.error("请求ID: {}, 请求URL: {}, 异常信息: {}", requestId, interfacePath, e.getMessage());
            
            return Result.error(ResultCode.SYSTEM_ERROR.getCode(), "系统内部错误");
        }
    }

    /**
     * 流程重放API
     * 用于重新执行失败的流程
     */
    @PostMapping("/api/replay/{executionId}")
    public Result<?> replayProcess(@PathVariable String executionId) {
        log.info("收到流程重放请求: {}", executionId);
        
        try {
            // 调用流程引擎进行重放
            Result<JSONObject> result = processEngine.replayProcess(executionId);
            
            log.info("流程重放完成: {}, 结果: {}", executionId, result.getCode());
            return result;
        } catch (Exception e) {
            log.error("流程重放异常: {}", e.getMessage(), e);
            return Result.error(ResultCode.SYSTEM_ERROR.getCode(), "流程重放失败: " + e.getMessage());
        }
    }

    /**
     * 构建处理上下文
     */
    private ProcessContext buildProcessContext(HttpServletRequest request, Map<String, Object> requestBody, 
                                             String interfaceCode, SysInterfaceDefinitionEntity interfaceDefinition) {
        ProcessContext context = new ProcessContext();
        
        // 1. 设置请求ID
        String requestId = UUID.randomUUID().toString();
        context.setRequestId(requestId);
        
        // 2. 设置接口代码
        context.setInterfaceCode(interfaceCode);
        
        // 3. 获取AppKey（从请求头或参数中获取）
        String appKey = request.getHeader("appKey");
        if (appKey == null || appKey.isEmpty()) {
            appKey = request.getParameter("appKey");
        }
        if (appKey == null || appKey.isEmpty() && requestBody != null) {
            appKey = (String) requestBody.get("appKey");
        }
        context.setAppKey(appKey);
        
        // 4. 构建请求参数
        Map<String, Object> requestParams = new HashMap<>();
        
        // 添加请求参数
        Map<String, String[]> parameterMap = request.getParameterMap();
        for (Map.Entry<String, String[]> entry : parameterMap.entrySet()) {
            if (entry.getValue().length == 1) {
                requestParams.put(entry.getKey(), entry.getValue()[0]);
            } else {
                requestParams.put(entry.getKey(), entry.getValue());
            }
        }
        
        // 添加请求体参数
        if (requestBody != null) {
            requestParams.putAll(requestBody);
        }

       // requestParams.put("_headers", headers);
        
        // 添加请求方法
        requestParams.put("_method", request.getMethod());
        
        // 添加URL路径信息，用于根据后缀识别接口
        requestParams.put("_url", request.getRequestURI());
        
        // 获取URL后缀（例如：/api/user/list.json -> json）
        String url = request.getRequestURI();
        int lastDotIndex = url.lastIndexOf('.');
        if (lastDotIndex > 0) {
            String suffix = url.substring(lastDotIndex + 1);
            requestParams.put("_urlSuffix", suffix);
        }
        
        context.setRequestParams(requestParams);
        
        // 5. 添加其他必要信息
        context.setAttribute("requestIp", getClientIp(request));
        context.setAttribute("interfaceDefinition", interfaceDefinition);
        
        return context;
    }

    /**
     * 获取客户端IP地址
     */
    private String getClientIp(HttpServletRequest request) {
        String ip = request.getHeader("X-Forwarded-For");
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getHeader("Proxy-Client-IP");
        }
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getHeader("WL-Proxy-Client-IP");
        }
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getRemoteAddr();
        }
        
        // 多级代理的情况，取第一个IP
        if (ip != null && ip.contains(",")) {
            ip = ip.split(",")[0].trim();
        }
        
        return ip;
    }
}
```

### 6.2 ProcessEngine核心代码

ProcessEngine是流程引擎的核心实现，负责执行流程、管理节点链、处理异步执行和重试逻辑。

```java
@Component
public class ProcessEngine {
    @Autowired
    private SysProcessNodeConfigService processNodeConfigService;
    @Autowired
    private SysProcessExecutionRecordService processExecutionRecordService;
    @Autowired
    private Map<String, Node> nodeMap;
    
    // 异步执行线程池
    private final ExecutorService asyncExecutor = new ThreadPoolExecutor(
            10, // 核心线程数
            50, // 最大线程数
            60L, TimeUnit.SECONDS, // 空闲线程存活时间
            new LinkedBlockingQueue<>(1000), // 工作队列
            new ThreadPoolExecutor.CallerRunsPolicy() // 拒绝策略
    );
    
    /**
     * 执行流程
     * @param processCode 流程代码
     * @param context 处理上下文
     * @return 执行结果
     */
    public Result<JSONObject> executeProcess(String processCode, ProcessContext context) {
        // 创建流程执行记录
        // 查询流程节点配置
        // 按顺序执行节点（同步或异步）
        // 处理执行结果
    }
    
    /**
     * 重放流程执行
     * @param executionId 执行ID
     * @return 执行结果
     */
    public Result<JSONObject> replayProcess(String executionId) {
        // 恢复上下文并重放流程
    }
}
```

## 7. 接口设计

### 7.1 认证接口

- **获取令牌**：`POST /auth/token`
- **修改密码**：`POST /auth/changePassword`
- **获取公钥**：`GET /auth/publicKey`

### 7.2 业务接口

所有业务接口统一通过 `POST /api/{interfaceCode}` 格式暴露，具体接口代码通过数据库配置。

## 8. 配置项说明

系统主要配置项包括：

- 服务器配置（端口、上下文路径、线程池等）
- 数据源配置（URL、用户名、密码等）
- Redis缓存配置（连接信息、过期时间等）
- 全国节点配置（URL、超时时间、重试策略等）
- 接口处理配置（超时时间、最大处理时间等）
- 安全配置（令牌有效期、签名算法等）
- 日志配置（级别、路径、敏感字段过滤等）

## 9. 部署说明

系统采用标准的Spring Boot应用部署方式，支持以下部署模式：

- 独立JAR部署
- Docker容器化部署
- 容器编排平台部署（如Kubernetes）

## 10. 扩展指南

系统设计考虑了扩展性，支持以下方式进行扩展：

- 添加新的处理节点：实现Node接口
- 添加新的异常类型：继承BaseException类
- 自定义安全过滤器：继承OncePerRequestFilter类

## 11. 性能优化建议

- 使用连接池管理数据库连接
- 合理配置线程池参数
- 使用缓存减少数据库访问
- 优化全国节点调用的重试策略
- 定期清理日志数据

## 12. 安全建议

- 定期更新密钥和证书
- 实施严格的访问控制策略
- 敏感数据加密存储和传输
- 防止SQL注入、XSS等常见安全漏洞
- 定期进行安全审计和漏洞扫描

## 13. 版本控制

| 版本 | 日期       | 描述               | 作者   |
|------|------------|--------------------|--------|
| 1.0  | 2023-10-20 | 初始设计文档       | System |
| 1.1  | 2025-09-17 | 更新实体模型和缓存机制 | System |
| 1.2  | 2025-10-01 | 添加数据库设计和代码示例 | System |

---
文档创建日期：2025-10-01