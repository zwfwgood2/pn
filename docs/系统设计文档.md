## 1. 系统概述

省级节点服务是连接市级节点与全国节点的中间层服务，负责数据的中转、验证、路由和日志记录。该服务采用模块化、可扩展的设计，支持不同类型接口的灵活处理。

## 2. 系统架构

系统采用分层架构设计，主要包括以下几层：

1. **API层**：接收市级节点的请求，统一入口
2. **控制层**：处理请求路由和响应返回
3. **处理层**：实现核心业务逻辑，采用节点链模式
4. **数据访问层**：与数据库交互，提供数据持久化功能
5. **公共层**：提供通用组件和工具类
6. **缓存层**：使用Redis缓存常用数据，提高系统性能

系统架构图如下：

```
┌───────────────┐     ┌───────────────┐     ┌───────────────┐
│  市级节点A    │     │  市级节点B    │     │  市级节点C    │
└───────────────┘     └───────────────┘     └───────────────┘
        │                     │                     │
        └─────────────┬───────┴─────────────┬───────┘
                      │                     │
              ┌───────▼─────────────────────▼───────┐
              │             省级节点服务             │
              ├─────────────────────────────────────┤
              │  API层  │  控制层  │  处理层  │ 数据层│
              │─────────┼─────────┼─────────┼───────│
              │ Main    │ Main    │Interface│ JPA   │
              │Controller│Controller│Processor│Repositories│
              │ Auth    │         │  Node   │ MyBatis│
              │Controller│         │  Chain  │ Mapper │
              ├─────────────────────────────────────┤
              │               缓存层                │
              │            Redis缓存服务            │
              └─────────────────────────────────────┘
                      │                     │
              ┌───────▼─────────┐   ┌───────▼───────┐
              │  本地数据库     │   │  全国节点服务  │
              └─────────────────┘   └───────────────┘
```

## 3. 核心功能模块

### 3.1 接口处理框架

采用责任链模式设计的节点处理框架，支持灵活配置和组合不同的处理节点，以适应不同类型接口的处理需求。

主要组件：
- **Node**：基础节点接口，定义了处理逻辑
- **InterfaceProcessor**：接口处理器，负责组织和执行节点链
- **InterfaceProcessorFactory**：处理器工厂，根据接口类型选择合适的处理器
- **ProcessEngine**：流程引擎，负责执行节点链

### 3.2 安全认证模块

提供完整的认证授权机制，确保只有授权的市级节点可以访问系统。

主要功能：
- 令牌验证（TokenValidateNode）
- 签名验证（SignatureVerifyNode）
- 数据签名（SignatureNode）
- 接入机构认证

### 3.3 参数验证模块

提供灵活的参数验证机制，确保请求参数的合法性和完整性。

主要功能：
- 参数必填性检查
- 数据类型验证
- 长度校验
- 正则表达式验证

### 3.4 日志记录模块

记录详细的请求和响应日志，用于审计、排查问题和性能监控。

主要功能：
- 请求参数记录
- 处理结果记录
- 异常信息记录
- 处理时间统计
- 流程执行记录

### 3.5 重试与异常处理模块

提供完善的重试机制和异常处理策略，确保系统的高可用性和稳定性。

主要功能：
- 指数退避重试
- 异常分类处理
- 错误码映射

### 3.6 缓存管理模块

使用Redis缓存常用数据，提高系统性能，减轻数据库压力。

主要功能：
- 系统启动时缓存预热（CacheInitializer）
- 接入机构信息多维度缓存
- 流程节点配置缓存
- 缓存自动刷新机制

## 4. 核心实体

### 4.1 AccessOrganization

接入机构实体类，合并了User和Organization的功能，用于存储市级节点等机构信息。

主要属性：
- id：唯一标识
- orgName：机构名称
- orgCode：机构代码
- username：用户名（登录账号）
- password：密码
- appKey：应用密钥
- publicKey：公钥
- privateKey：私钥
- status：状态（0:禁用, 1:启用）
- createTime：创建时间
- updateTime：更新时间
- lastLoginTime：最后登录时间
- isAdmin：是否管理员
- structureType：结构类型（0:省级节点, 1:市级节点, 2:其他）
- contactPerson：联系人
- contactPhone：联系电话
- description：描述

### 4.2 InterfaceDefinition

接口定义实体类，存储系统中所有接口的定义信息。

主要属性：
- id：唯一标识
- interfaceCode：接口代码
- interfaceName：接口名称
- interfaceType：接口类型（0:查询接口, 1:写入接口）
- requestMethod：请求方法（GET, POST, PUT, DELETE等）
- requestPath：请求路径
- processCode：关联的流程定义代码
- processConfig：接口处理流程配置
- paramValidateConfig：参数校验配置
- status：状态（0:禁用, 1:启用）
- createTime：创建时间
- updateTime：更新时间
- description：描述

### 4.3 ProcessDefinition

流程定义实体类，存储接口处理流程的定义信息。

主要属性：
- id：唯一标识
- processCode：流程代码
- processName：流程名称
- interfaceCode：接口代码
- description：描述
- status：状态（0:禁用, 1:启用）
- createTime：创建时间
- updateTime：更新时间

### 4.4 ProcessNodeConfig

流程节点配置实体类，存储流程中每个节点的配置信息。

主要属性：
- id：唯一标识
- processCode：流程代码
- nodeId：节点ID
- nodeName：节点名称
- nodeOrder：节点顺序
- retryConfig：重试配置
- asyncExecution：是否异步执行
- nodeConfig：节点配置参数
- status：状态（0:禁用, 1:启用）
- createTime：创建时间
- updateTime：更新时间

### 4.5 RequestLog

请求日志实体类，记录每次接口调用的详细信息。

主要属性：
- id：唯一标识
- requestId：请求ID
- interfaceCode：接口代码
- appKey：应用密钥
- requestTime：请求时间
- responseTime：响应时间
- requestParams：请求参数
- responseResult：响应结果
- status：状态（0:失败, 1:成功）
- errorMessage：错误信息
- requestIp：请求IP
- processingTime：处理耗时（毫秒）

## 5. 接口设计

### 5.1 认证接口

- **获取令牌**：`POST /auth/token`
- **修改密码**：`POST /auth/changePassword`
- **获取公钥**：`GET /auth/publicKey`

### 5.2 业务接口

所有业务接口统一通过 `POST /api/{interfaceCode}` 格式暴露，具体接口代码通过数据库配置。

## 6. 配置项说明

系统主要配置项包括：

- 服务器配置（端口、上下文路径、线程池等）
- 数据源配置（URL、用户名、密码等）
- Redis缓存配置（连接信息、过期时间等）
- 全国节点配置（URL、超时时间、重试策略等）
- 接口处理配置（超时时间、最大处理时间等）
- 安全配置（令牌有效期、签名算法等）
- 日志配置（级别、路径、敏感字段过滤等）

## 7. 部署说明

系统采用标准的Spring Boot应用部署方式，支持以下部署模式：

- 独立JAR部署
- Docker容器化部署
- 容器编排平台部署（如Kubernetes）

## 8. 扩展指南

系统设计考虑了扩展性，支持以下方式进行扩展：

- 添加新的处理节点：实现Node接口
- 添加新的接口处理器：实现InterfaceProcessor接口
- 添加新的异常类型：继承BaseException类
- 自定义安全过滤器：继承OncePerRequestFilter类

## 9. 性能优化建议

- 使用连接池管理数据库连接
- 合理配置线程池参数
- 使用缓存减少数据库访问
- 优化全国节点调用的重试策略
- 定期清理日志数据

## 10. 安全建议

- 定期更新密钥和证书
- 实施严格的访问控制策略
- 敏感数据加密存储和传输
- 防止SQL注入、XSS等常见安全漏洞
- 定期进行安全审计和漏洞扫描

## 11. 版本控制

| 版本 | 日期       | 描述               | 作者   |
|------|------------|--------------------|--------|
| 1.0  | 2023-10-20 | 初始设计文档       | System |
| 1.1  | 2025-09-17 | 更新实体模型和缓存机制 | System |

---
文档创建日期：2025-09-17