# 数据库设计文档

## 1. 数据库概述

省级节点服务采用关系型数据库存储系统数据，包括接入机构信息、接口定义、流程配置和请求日志等。本文档详细描述了系统的数据库设计，包括表结构、字段定义、索引和表关系等。

## 2. 数据库连接信息

- **数据库类型**：MySQL
- **字符集**：UTF-8mb4
- **排序规则**：utf8mb4_unicode_ci
- **连接池**：HikariCP

## 3. 表结构设计

### 3.1 sys_access_organization（接入机构表）

存储接入机构信息，合并了原User和Organization表的功能。

```sql
CREATE TABLE `sys_access_organization` (
   `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
   `org_name` varchar(100) NOT NULL COMMENT '机构名称',
   `org_code` varchar(50) NOT NULL COMMENT '机构代码',
   `username` varchar(50) NOT NULL COMMENT '用户名（登录账号）',
   `password` varchar(255) NOT NULL COMMENT '密码（加密存储）',
   `app_key` varchar(100) NOT NULL COMMENT '应用密钥',
   `public_key` text COMMENT '公钥',
   `private_key` text COMMENT '私钥（加密存储）',
   `status` tinyint NOT NULL DEFAULT '1' COMMENT '状态：0-禁用，1-启用',
   `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
   `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
   `last_login_time` datetime DEFAULT NULL COMMENT '最后登录时间',
   `is_admin` tinyint NOT NULL DEFAULT '0' COMMENT '是否管理员：0-否，1-是',
   `structure_type` tinyint NOT NULL DEFAULT '1' COMMENT '结构类型：0-省级节点，1-市级节点，2-其他',
   `contact_person` varchar(50) DEFAULT NULL COMMENT '联系人',
   `contact_phone` varchar(20) DEFAULT NULL COMMENT '联系电话',
   `description` varchar(255) DEFAULT NULL COMMENT '描述',
   PRIMARY KEY (`id`),
   UNIQUE KEY `uk_org_code` (`org_code`),
   UNIQUE KEY `uk_username` (`username`),
   UNIQUE KEY `uk_app_key` (`app_key`),
   KEY `idx_status` (`status`),
   KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='接入机构表';
```

### 3.2 sys_interface_definition（接口定义表）

存储系统中所有接口的定义信息。

```sql
CREATE TABLE `sys_interface_definition` (
    `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `interface_code` varchar(50) NOT NULL COMMENT '接口代码',
    `interface_name` varchar(100) NOT NULL COMMENT '接口名称',
    `interface_type` tinyint NOT NULL DEFAULT '0' COMMENT '接口类型：0-查询接口，1-写入接口',
    `request_method` varchar(20) NOT NULL DEFAULT 'POST' COMMENT '请求方法：GET, POST, PUT, DELETE等',
    `request_path` varchar(200) NOT NULL COMMENT '请求路径',
    `process_code` varchar(50) NOT NULL COMMENT '关联的流程定义代码',
    `status` tinyint NOT NULL DEFAULT '1' COMMENT '状态：0-禁用，1-启用',
    `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `description` varchar(255) DEFAULT NULL COMMENT '描述',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_interface_code` (`interface_code`),
    UNIQUE KEY `uk_request_path` (`request_path`),
    KEY `idx_interface_type` (`interface_type`),
    KEY `idx_status` (`status`),
    KEY `idx_process_code` (`process_code`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='接口定义表';
```

### 3.3 sys_process_definition（流程定义表）

存储接口处理流程的定义信息。

```sql
CREATE TABLE `sys_process_definition` (
      `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
      `process_code` varchar(50) NOT NULL COMMENT '流程代码',
      `process_name` varchar(100) NOT NULL COMMENT '流程名称',
      `interface_code` varchar(50) DEFAULT NULL COMMENT '接口代码（关联sys_interface_definition表）',
      `description` varchar(255) DEFAULT NULL COMMENT '描述',
      `status` tinyint NOT NULL DEFAULT '1' COMMENT '状态：0-禁用，1-启用',
      `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
      `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
      PRIMARY KEY (`id`),
      UNIQUE KEY `uk_process_code` (`process_code`),
      KEY `idx_interface_code` (`interface_code`),
      KEY `idx_status` (`status`),
      KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='流程定义表';
```

### 3.4 sys_process_node_config（流程节点配置表）

存储流程中每个节点的配置信息。

```sql
CREATE TABLE `sys_process_node_config` (
   `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
   `process_code` varchar(50) NOT NULL COMMENT '流程代码（关联sys_process_definition表）',
   `node_id` varchar(50) NOT NULL COMMENT '节点ID',
   `node_name` varchar(100) NOT NULL COMMENT '节点名称',
   `node_order` int NOT NULL COMMENT '节点顺序',
   `retry_config` text COMMENT '重试配置（JSON格式）',
   `async_execution` tinyint NOT NULL DEFAULT '0' COMMENT '是否异步执行：0-否，1-是',
   `node_config` text COMMENT '节点配置参数（JSON格式）',
   `status` tinyint NOT NULL DEFAULT '1' COMMENT '状态：0-禁用，1-启用',
   `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
   `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
   PRIMARY KEY (`id`),
   UNIQUE KEY `uk_process_code_node_id` (`process_code`,`node_id`),
   KEY `idx_process_code` (`process_code`),
   KEY `idx_status` (`status`),
   KEY `idx_node_order` (`node_order`)
) ENGINE=InnoDB AUTO_INCREMENT=16 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='流程节点配置表';
```

### 3.5 sys_process_execution_record（流程执行记录表）

存储流程执行的详细信息，支持流程重放。

```sql
CREATE TABLE `sys_process_execution_record` (
                `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
                `execution_id` varchar(100) NOT NULL COMMENT '执行ID',
                `request_id` varchar(100) NOT NULL COMMENT '请求ID',
                `process_code` varchar(50) NOT NULL COMMENT '流程代码（关联sys_process_definition表）',
                `interface_code` varchar(50) NOT NULL COMMENT '接口代码（关联sys_interface_definition表）',
                `app_key` varchar(100) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci DEFAULT NULL COMMENT '应用密钥（关联sys_access_organization表）',
                `start_time` datetime NOT NULL COMMENT '开始时间',
                `end_time` datetime DEFAULT NULL COMMENT '结束时间',
                `status` tinyint NOT NULL DEFAULT '0' COMMENT '状态：0-初始，1-执行中，2-成功，3-失败，4-需要重试',
                `error_message` text COMMENT '错误信息',
                `retry_count` int NOT NULL DEFAULT '0' COMMENT '重试次数',
                `max_retry_count` int NOT NULL DEFAULT '3' COMMENT '最大重试次数',
                `current_node_id` varchar(50) DEFAULT NULL COMMENT '当前节点ID',
                `execution_context` longtext COMMENT '执行上下文，JSON格式，用于重放',
                `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
                PRIMARY KEY (`id`),
                UNIQUE KEY `uk_execution_id` (`execution_id`),
                KEY `idx_request_id` (`request_id`),
                KEY `idx_process_code` (`process_code`),
                KEY `idx_interface_code` (`interface_code`),
                KEY `idx_app_key` (`app_key`),
                KEY `idx_status` (`status`),
                KEY `idx_start_time` (`start_time`)
) ENGINE=InnoDB AUTO_INCREMENT=1969987011043045378 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='流程执行记录表';
```

### 3.6 sys_request_log（请求日志表）

记录每次接口调用的详细信息。

```sql
CREATE TABLE `sys_request_log` (
           `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
           `request_id` varchar(100) NOT NULL COMMENT '请求ID',
           `interface_code` varchar(50) NOT NULL COMMENT '接口代码',
           `app_key` varchar(100) NOT NULL COMMENT '应用密钥（关联sys_access_organization表）',
           `request_time` datetime NOT NULL COMMENT '请求时间',
           `response_time` datetime DEFAULT NULL COMMENT '响应时间',
           `request_params` text COMMENT '请求参数（JSON格式）',
           `response_result` text COMMENT '响应结果（JSON格式）',
           `status` tinyint NOT NULL DEFAULT '0' COMMENT '状态：0-失败，1-成功',
           `error_message` text COMMENT '错误信息',
           `request_ip` varchar(50) DEFAULT NULL COMMENT '请求IP',
           `processing_time` bigint DEFAULT NULL COMMENT '处理耗时（毫秒）',
           PRIMARY KEY (`id`),
           KEY `idx_request_id` (`request_id`),
           KEY `idx_interface_code` (`interface_code`),
           KEY `idx_app_key` (`app_key`),
           KEY `idx_request_time` (`request_time`),
           KEY `idx_status` (`status`)
) ENGINE=InnoDB AUTO_INCREMENT=1969987075840847874 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='请求日志表';
```
## 4. 表关系图

```
┌─────────────────────────────┐       ┌─────────────────────────────┐
│  sys_access_organization    │       │  sys_interface_definition   │
│                             │       │                             │
│  - id                       │       │  - id                       │
│  - org_code                 │       │  - interface_code           │
│  - username                 │       │  - interface_name           │
│  - app_key                  │       │  - interface_type           │
│  - status                   │       │  - request_method           │
│  - create_time              │       │  - request_path             │
│  - update_time              │       │  - process_code             │
│  - last_login_time          │       │  - status                   │
│  - is_admin                 │       │  - create_time              │
│  - structure_type           │       │  - update_time              │
│  - contact_person           │       │  - description              │
│  - contact_phone            │       │                             │
│  - description              │       │                             │
└───────────┬─────────────────┘       └───────────┬─────────────────┘
            │                                     │
            │                                     │
            │                                     ▼
            │                             ┌─────────────────────────────┐
            │                             │    sys_process_definition   │
            │                             │                             │
            │                             │  - id                       │
            │                             │  - process_code             │
            │                             │  - process_name             │
            │                             │  - interface_code           │
            │                             │  - status                   │
            │                             │  - create_time              │
            │                             │  - update_time              │
            │                             │  - description              │
            │                             │                             │
            │                             └───────────┬─────────────────┘
            │                                         │
            │                                         │
            │                                         ▼
            │                                 ┌─────────────────────────┐
            │                                 │ sys_process_node_config │
            │                                 │                         │
            │                                 │  - id                   │
            │                                 │  - process_code         │
            │                                 │  - node_id              │
            │                                 │  - node_name            │
            │                                 │  - node_order           │
            │                                 │  - retry_config         │
            │                                 │  - async_execution      │
            │                                 │  - node_config          │
            │                                 │  - status               │
            │                                 │  - create_time          │
            │                                 │  - update_time          │
            │                                 │                         │
            │                                 └─────────┬───────────────┘
            │                                           │
            │                                           │
            │                                           ▼
            │                                 ┌─────────────────────────────────┐
            │                                 │    sys_process_execution_record  │
            │                                 │                                 │
            │                                 │  - id                           │
            │                                 │  - execution_id                 │
            │                                 │  - request_id                   │
            │                                 │  - process_code                 │
            │                                 │  - interface_code               │
            │                                 │  - app_key                      │
            │                                 │  - start_time                   │
            │                                 │  - end_time                     │
            │                                 │  - status                       │
            │                                 │  - error_message                │
            │                                 │  - retry_count                  │
            │                                 │  - max_retry_count              │
            │                                 │  - current_node_id              │
            │                                 │  - execution_context            │
            │                                 │  - update_time                  │
            │                                 │                                 │
            │                                 └─────────────────────────────────┘
            │
            ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                              sys_request_log                             │
│                                                                          │
│  - id                                                                   │
│  - request_id                                                           │
│  - interface_code                                                       │
│  - app_key                                                              │
│  - request_time                                                         │
│  - response_time                                                        │
│  - request_params                                                       │
│  - response_result                                                      │
│  - status                                                               │
│  - error_message                                                        │
│  - request_ip                                                           │
│  - processing_time                                                      │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

## 5. 索引设计

### 5.1 唯一索引

- `sys_access_organization`: `uk_org_code`, `uk_username`, `uk_app_key`
- `sys_interface_definition`: `uk_interface_code`, `uk_request_path`
- `sys_process_definition`: `uk_process_code`
- `sys_process_node_config`: `uk_process_code_node_id`
- `sys_process_execution_record`: `uk_execution_id`
- `sys_authorization_letter`: `uk_auth_identifier`

### 5.2 普通索引

- `sys_access_organization`: `idx_status`, `idx_create_time`
- `sys_interface_definition`: `idx_interface_type`, `idx_status`, `idx_process_code`
- `sys_process_definition`: `idx_interface_code`, `idx_status`, `idx_create_time`
- `sys_process_node_config`: `idx_process_code`, `idx_status`, `idx_node_order`
- `sys_process_execution_record`: `idx_request_id`, `idx_process_code`, `idx_interface_code`, `idx_app_key`, `idx_status`, `idx_start_time`
- `sys_request_log`: `idx_request_id`, `idx_interface_code`, `idx_app_key`, `idx_request_time`, `idx_status`
- `sys_authorization_letter`: `idx_auth_org_id`, `idx_status`, `idx_start_time`, `idx_end_time`

## 6. 数据存储策略

### 6.1 数据分区

对于日志表`sys_request_log`，建议按照时间进行分区，便于数据归档和查询优化。

```sql
ALTER TABLE `sys_request_log` PARTITION BY RANGE (TO_DAYS(request_time)) (
  PARTITION p202501 VALUES LESS THAN (TO_DAYS('2025-02-01')),
  PARTITION p202502 VALUES LESS THAN (TO_DAYS('2025-03-01')),
  -- 更多分区...
);
```

### 6.2 数据归档

对于历史日志数据，建议定期进行归档处理，例如将超过90天的日志数据迁移到归档表或数据仓库中。

### 6.3 数据备份与恢复

- 定期进行数据库全量备份和增量备份
- 建立数据库恢复机制和测试流程

## 7. 性能优化建议

1. **使用连接池**：配置合适的连接池参数，优化数据库连接管理
2. **合理使用索引**：根据查询场景创建合适的索引，避免索引失效
3. **查询优化**：使用分页查询、避免SELECT *、减少子查询等
4. **事务优化**：缩小事务范围，避免长时间占用锁资源
5. **分表分库**：对于大数据量的日志表，可以考虑水平分表或分库
6. **读写分离**：在高并发场景下，可以考虑采用读写分离架构
7. **缓存策略**：合理使用Redis缓存常用数据，减轻数据库压力

## 8. 安全建议

1. **数据加密**：敏感数据（如密码、私钥）进行加密存储
2. **访问控制**：严格控制数据库用户权限，避免使用root用户
3. **SQL注入防护**：使用参数化查询，避免直接拼接SQL语句
4. **定期审计**：定期检查数据库访问日志和权限变更记录
5. **备份安全**：备份文件进行加密处理，妥善存储

## 9. 版本控制

| 版本 | 日期       | 描述               | 作者   |
|------|------------|--------------------|--------|
| 1.0  | 2023-10-20 | 初始数据库设计文档 | System |
| 1.1  | 2025-09-17 | 更新表结构和索引设计 | System |
| 1.2  | 2024-04-28 | 添加流程执行记录表和授权书表，更新表结构以匹配实体类 | System |

---
文档创建日期：2025-09-24